# design-systems-7-first-system


## Основная бизнес-логика

### Процесс назначения заказа
1. Получает запросы на назначение заказа с ID заказа и ID исполнителя
2. Собирает необходимую информацию из нескольких внешних сервисов:
   - Данные заказа
   - Информация о зоне
   - Профиль исполнителя
   - Параметры конфигурации
   - Данные о платных дорогах
3. Рассчитывает оплату на основе:
   - Базовой суммы монет
   - Коэффициентов зоны
   - Бонусов за платные дороги
4. Генерирует информацию о маршруте на основе рейтинга исполнителя и зоны
5. Сохраняет информацию о заказе в базе данных PostgreSQL

### Ключевые особенности
- Асинхронный сбор данных из нескольких источников
- Стратегии отказоустойчивости с Redis-кэшированием
- Настраиваемые тайм-ауты и политики повторных попыток
- Управление статусом заказа (активный, взят, отменен, выполнен)
- Безопасный временной интервал для отмены заказа

## Структура компонентов

### Основные компоненты
```
/backend/app/
├── core/
│   ├── assign_order_service/
│   │   ├── assign_order_service.py    # Основная бизнес-логика
│   │   ├── data_provider.py           # Получение внешних данных
│   │   ├── payment_calculator.py      # Расчет стоимости
│   │   └── route_information_provider.py # Генерация маршрута
│   └── config.py                      # Конфигурация сервиса
```

### Слой данных
```
/backend/app/
├── models/
│   ├── order.py                       # Модели базы данных
│   └── base_class.py                  # Базовый класс SQLAlchemy
├── schemas/
│   ├── order.py                       # Объекты передачи данных
│   └── requests_config.py             # Конфигурации HTTP-запросов
└── crud/
    └── order.py                       # Операции с базой данных
```

### API слой
```
/backend/app/
├── api/
│   ├── main.py                        # Конфигурация API роутера
│   └── routes/
│       ├── assign_order.py            # Эндпоинты заказов
│       └── utils.py                   # Служебные эндпоинты
```

## Инфраструктурные компоненты

### Сервисы (docker-compose.yml)
1. **Redis Cache**
   - Конфигурация: LRU-кэш, 500MB максимальной памяти
   - Используется для: Кэширования ответов внешних сервисов

2. **PostgreSQL Database**
   - Версия: 12
   - Открытый порт: 5432

3. **Backend Service**
   - Собирается из контекста ./backend
   - Открытый порт: 8000
   - Зависимости: PostgreSQL, Redis Cache, External APIs

4. **External APIs Service**
   - Предоставляет мок-эндпоинты для внешних сервисов
   - Порт: 3629

### Конфигурация
- Переменные окружения в файле `.env`
- Конфигурации внешних сервисов в `data_sources_config.json`
- Миграции базы данных управляются через Alembic

## API Endpoints с примерами

### Управление заказами

#### Назначение заказа
```http
POST /api/v1/assign_order

Параметры запроса:
- order_id: string (ID заказа)
- executer_id: string (ID исполнителя)
- locale: string (локаль)

Пример запроса:
curl -X POST "http://localhost:8000/api/v1/assign_order?order_id=12345&executer_id=789&locale=ru"

Пример ответа:
{
    "assigned_order_id": "550e8400-e29b-41d4-a716-446655440000",
    "order_id": "12345",
    "executer_id": "789",
    "coin_coeff": 2.0,
    "coin_bonus_amount": 50.0,
    "final_coin_amount": 250.0,
    "route_information": "Order at zone 'Центральный район'",
    "assign_time": "2024-11-17T14:30:00",
    "acquire_time": null
}

Статус: 201 Created
```

#### Отмена заказа
```http
POST /api/v1/cancel_order

Параметры:
- assigned_order_id: UUID (ID назначенного заказа)

Пример запроса:
curl -X POST "http://localhost:8000/api/v1/cancel_order?assigned_order_id=550e8400-e29b-41d4-a716-446655440000"

Пример ответа:
{
    "assigned_order_id": "550e8400-e29b-41d4-a716-446655440000",
    "order_id": "12345",
    "executer_id": "789",
    "coin_coeff": 2.0,
    "coin_bonus_amount": 50.0,
    "final_coin_amount": 250.0,
    "route_information": "Order at zone 'Центральный район'",
    "assign_time": "2024-11-17T14:30:00",
    "acquire_time": null
}

Статус: 200 OK
```

### Служебные эндпоинты

#### Проверка работоспособности
```http
GET /api/v1/utils/health-check/

Пример запроса:
curl "http://localhost:8000/api/v1/utils/health-check/"

Пример ответа:
true

Статус: 200 OK
```

#### Перезагрузка конфигурации
```http
GET /api/v1/reload_config

Пример запроса:
curl "http://localhost:8000/api/v1/reload_config"

Пример ответа:
null

Статус: 200 OK
```

## Зависимости от внешних сервисов

### Необходимые внешние API
1. **Сервис данных заказа**
   - Эндпоинт: `/order-data`
   - Кэширование отключено
   
2. **Сервис данных зоны**
   - Эндпоинт: `/zone-data`
   - Кэширование включено (TTL: 600с)
   
3. **Сервис профиля исполнителя**
   - Эндпоинт: `/executer-profile`
   - Кэширование отключено
   
4. **Сервис платных дорог**
   - Эндпоинт: `/toll-roads`
   - Кэширование включено
   - Доступен откат к конфигурации
   
5. **Сервис конфигурации**
   - Эндпоинт: `/configs`
   - Периодические обновления кэша

## Настройка окружения разработки

### Предварительные требования
- Docker и Docker Compose
- Python 3.10

### Локальная разработка
```bash
docker-compose up -d
```

### Тестирование
Запуск тестов:
```bash
./scripts/test-local.sh
```
